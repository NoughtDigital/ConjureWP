name: Deploy to Freemius

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

jobs:
  deploy:
    name: Deploy to Freemius
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          extensions: mbstring, xml, zip
          coverage: none
      
      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader
      
      - name: Install Node dependencies
        run: npm ci
      
      - name: Build assets
        run: npm run build
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create plugin ZIP
        run: |
          mkdir -p dist
          zip -r dist/conjurewp.zip . \
            -x "*.git*" \
            -x "*node_modules/*" \
            -x "*.github/*" \
            -x "*tests/*" \
            -x "*examples/*" \
            -x "*.md" \
            -x "phpcs.xml" \
            -x "composer.json" \
            -x "composer.lock" \
            -x "package.json" \
            -x "package-lock.json" \
            -x "vite.config.js" \
            -x "*dist/*" \
            -x "*.DS_Store"
      
      - name: Deploy to Freemius
        uses: buttonizer/freemius-deploy@v0.1.2
        with:
          file_name: conjurewp.zip
          release_mode: pending  # Change to 'released' to auto-publish
          version: ${{ steps.get_version.outputs.VERSION }}
          sandbox: false  # Set to true for testing
        env:
          PUBLIC_KEY: ${{ secrets.FREEMIUS_PUBLIC_KEY }}
          DEV_ID: ${{ secrets.FREEMIUS_DEV_ID }}
          SECRET_KEY: ${{ secrets.FREEMIUS_SECRET_KEY }}
          PLUGIN_SLUG: conjurewp
          PLUGIN_ID: 21879
      
      - name: Upload free version as artifact
        uses: actions/upload-artifact@v3
        with:
          name: conjurewp-free-${{ steps.get_version.outputs.VERSION }}
          path: ${{ steps.deploy.outputs.free_version }}
      
      - name: Upload premium version as artifact
        uses: actions/upload-artifact@v3
        with:
          name: conjurewp-premium-${{ steps.get_version.outputs.VERSION }}
          path: ${{ steps.deploy.outputs.pro_version }}


